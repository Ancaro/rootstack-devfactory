## Loki config is generated by ansible
{% if 'loki_server' in group_names %}
target: all
{% elif 'loki' in group_names %}
target: querier
{% endif %}

auth_enabled: false

server:
  http_listen_port: 8880
  http_listen_address: {{ vm_ip }}

distributor:
  ring:
    kvstore:
      store: consul
      consul:
        host: {{ vm_ip }}:8500

ingester:
  lifecycler:
    ring:
      kvstore:
        store: consul
        consul:
          host: {{ vm_ip }}:8500
      replication_factor: 1
    final_sleep: 0s
    interface_names: {{ ansible_interfaces }}
  chunk_idle_period: 5m
  chunk_retain_period: 30s

schema_config:
  configs:
    - from: 2021-04-01
      store: boltdb-shipper
      object_store: aws
      schema: v11
      index:
        prefix: index_
        period: 24h

storage_config:
  boltdb_shipper:
    active_index_directory: /home/loki/loki/index
    cache_location: /home/loki/loki/index_cache
    shared_store: aws

  aws:
    region: "s3.service.consul:9000"
    s3: s3://{{ s3_access_key }}:{{ s3_secret_key }}@s3.service.consul:9000/loki
    s3forcepathstyle: true
    endpoint: s3.service.consul:9000
    bucketnames: loki
    access_key_id: {{ s3_access_key }}
    secret_access_key: {{ s3_secret_key }}
    insecure: true
